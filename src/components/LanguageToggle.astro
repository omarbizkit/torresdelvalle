---
export interface Props {
  currentLocale?: 'es' | 'en';
}

const { currentLocale = 'es' } = Astro.props;

// Get current path without locale prefix
const currentPath = Astro.url.pathname;
const isEnglishPath = currentPath.startsWith('/en/');
const isRootEnglish = currentPath === '/en';

function getAlternativeUrl() {
  if (isEnglishPath) {
    // Convert /en/something to /something
    return currentPath.replace('/en', '') || '/';
  } else if (isRootEnglish) {
    // Convert /en to /
    return '/';
  } else {
    // Convert /something to /en/something
    return currentPath === '/' ? '/en' : `/en${currentPath}`;
  }
}

const alternativeUrl = getAlternativeUrl();
---

<div class="flex items-center space-x-4 font-body text-[0.7rem] tracking-[0.2em] uppercase" role="navigation" aria-label="Language selector">
  <button
    class={`transition-all duration-300 relative group ${
      currentLocale === 'es' 
        ? 'text-current opacity-100' 
        : 'text-current opacity-40 hover:opacity-100'
    }`}
    onclick={`setLanguage('${currentLocale === 'es' ? '/' : alternativeUrl}')`}
    aria-current={currentLocale === 'es' ? 'true' : 'false'}
  >
    ES
    <span class={`absolute -bottom-1 left-0 w-full h-[1px] bg-current transition-transform duration-300 ${currentLocale === 'es' ? 'scale-x-100' : 'scale-x-0 group-hover:scale-x-100'}`}></span>
  </button>
  
  <span class="opacity-20">/</span>
  
  <button
    class={`transition-all duration-300 relative group ${
      currentLocale === 'en' 
        ? 'text-current opacity-100' 
        : 'text-current opacity-40 hover:opacity-100'
    }`}
    onclick={`setLanguage('${currentLocale === 'en' ? '/' : alternativeUrl}')`}
    aria-current={currentLocale === 'en' ? 'true' : 'false'}
  >
    EN
    <span class={`absolute -bottom-1 left-0 w-full h-[1px] bg-current transition-transform duration-300 ${currentLocale === 'en' ? 'scale-x-100' : 'scale-x-0 group-hover:scale-x-100'}`}></span>
  </button>
</div>

<script>
  function setLanguage(url: string) {
    // Set language preference in cookie
    const isEnglish = url.includes('/en');
    document.cookie = `preferred-language=${isEnglish ? 'en' : 'es'}; path=/; max-age=31536000`;
    
    // Navigate to the new URL
    window.location.href = url;
  }
  
  // Check for stored language preference on page load
  document.addEventListener('DOMContentLoaded', function() {
    const cookies = document.cookie.split(';');
    const langCookie = cookies.find(cookie => cookie.trim().startsWith('preferred-language='));
    
    if (langCookie) {
      const preferredLang = langCookie.split('=')[1];
      const currentPath = window.location.pathname;
      const isCurrentlyEnglish = currentPath.startsWith('/en');
      
      // Redirect if language doesn't match preference
      if (preferredLang === 'en' && !isCurrentlyEnglish) {
        const newPath = currentPath === '/' ? '/en' : `/en${currentPath}`;
        window.location.href = newPath;
      } else if (preferredLang === 'es' && isCurrentlyEnglish) {
        const newPath = currentPath.replace('/en', '') || '/';
        window.location.href = newPath;
      }
    }
  });
</script>